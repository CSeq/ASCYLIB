/*   
 *   File: random.h
 *   Author: Vincent Gramoli <vincent.gramoli@sydney.edu.au>, 
 *  	     Tudor David <tudor.david@epfl.ch>
 *   Description: 
 *   random.h is part of ASCYLIB
 *
 * Copyright (c) 2014 Vasileios Trigonakis <vasileios.trigonakis@epfl.ch>,
 * 	     	      Tudor David <tudor.david@epfl.ch>
 *	      	      Distributed Programming Lab (LPD), EPFL
 *
 * ASCYLIB is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation, version 2
 * of the License.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 */

#ifndef _H_RANDOM_
#define _H_RANDOM_

#include <malloc.h>
#include "measurements.h"
#include "ssalloc.h"

#define LOCAL_RAND

#if defined(LOCAL_RAND)
extern __thread unsigned long* seeds; 
#endif

#define my_random xorshf96

#ifdef ZIPF_2048

int[] the_keys = { 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1025, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1026, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1027, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1028, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1029, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1030, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1031, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1032, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1033, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1034, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1035, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1036, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1037, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1038, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1039, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1040, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1041, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1042, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1043, 1044, 1044, 1044, 1044, 1044, 1044, 1044, 1044, 1044, 1044, 1044, 1045, 1045, 1045, 1045, 1045, 1045, 1045, 1045, 1045, 1045, 1045, 1046, 1046, 1046, 1046, 1046, 1046, 1046, 1046, 1046, 1046, 1047, 1047, 1047, 1047, 1047, 1047, 1047, 1047, 1047, 1047, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1048, 1049, 1049, 1049, 1049, 1049, 1049, 1049, 1049, 1049, 1050, 1050, 1050, 1050, 1050, 1050, 1050, 1050, 1050, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1051, 1052, 1052, 1052, 1052, 1052, 1052, 1052, 1052, 1053, 1053, 1053, 1053, 1053, 1053, 1053, 1053, 1054, 1054, 1054, 1054, 1054, 1054, 1054, 1055, 1055, 1055, 1055, 1055, 1055, 1055, 1056, 1056, 1056, 1056, 1056, 1056, 1056, 1057, 1057, 1057, 1057, 1057, 1057, 1057, 1058, 1058, 1058, 1058, 1058, 1058, 1058, 1059, 1059, 1059, 1059, 1059, 1059, 1060, 1060, 1060, 1060, 1060, 1060, 1061, 1061, 1061, 1061, 1061, 1061, 1062, 1062, 1062, 1062, 1062, 1062, 1063, 1063, 1063, 1063, 1063, 1063, 1064, 1064, 1064, 1064, 1064, 1064, 1065, 1065, 1065, 1065, 1065, 1065, 1066, 1066, 1066, 1066, 1066, 1067, 1067, 1067, 1067, 1067, 1068, 1068, 1068, 1068, 1068, 1069, 1069, 1069, 1069, 1069, 1070, 1070, 1070, 1070, 1070, 1071, 1071, 1071, 1071, 1071, 1072, 1072, 1072, 1072, 1072, 1073, 1073, 1073, 1073, 1073, 1074, 1074, 1074, 1074, 1074, 1075, 1075, 1075, 1075, 1076, 1076, 1076, 1076, 1077, 1077, 1077, 1077, 1078, 1078, 1078, 1078, 1079, 1079, 1079, 1079, 1080, 1080, 1080, 1080, 1081, 1081, 1081, 1081, 1082, 1082, 1082, 1082, 1083, 1083, 1083, 1083, 1084, 1084, 1084, 1084, 1085, 1085, 1085, 1085, 1086, 1086, 1086, 1086, 1087, 1087, 1087, 1087, 1088, 1088, 1088, 1088, 1089, 1089, 1089, 1090, 1090, 1090, 1091, 1091, 1091, 1092, 1092, 1092, 1093, 1093, 1093, 1094, 1094, 1094, 1095, 1095, 1095, 1096, 1096, 1096, 1097, 1097, 1097, 1098, 1098, 1098, 1099, 1099, 1099, 1100, 1100, 1100, 1101, 1101, 1101, 1102, 1102, 1102, 1103, 1103, 1103, 1104, 1104, 1104, 1105, 1105, 1105, 1106, 1106, 1106, 1107, 1107, 1107, 1108, 1108, 1108, 1109, 1109, 1109, 1110, 1110, 1110, 1111, 1111, 1111, 1112, 1112, 1112, 1113, 1113, 1113, 1114, 1114, 1115, 1115, 1116, 1116, 1117, 1117, 1118, 1118, 1119, 1119, 1120, 1120, 1121, 1121, 1122, 1122, 1123, 1123, 1124, 1124, 1125, 1125, 1126, 1126, 1127, 1127, 1128, 1128, 1129, 1129, 1130, 1130, 1131, 1131, 1132, 1132, 1133, 1133, 1134, 1134, 1135, 1135, 1136, 1136, 1137, 1137, 1138, 1138, 1139, 1139, 1140, 1140, 1141, 1141, 1142, 1142, 1143, 1143, 1144, 1144, 1145, 1145, 1146, 1146, 1147, 1147, 1148, 1148, 1149, 1149, 1150, 1150, 1151, 1151, 1152, 1152, 1153, 1153, 1154, 1154, 1155, 1155, 1156, 1156, 1157, 1157, 1158, 1158, 1159, 1159, 1160, 1160, 1161, 1161, 1162, 1162, 1163, 1163, 1164, 1165, 1166, 1167, 1168, 1169, 1170, 1171, 1172, 1173, 1174, 1175, 1176, 1177, 1178, 1179, 1180, 1181, 1182, 1183, 1184, 1185, 1186, 1187, 1188, 1189, 1190, 1191, 1192, 1193, 1194, 1195, 1196, 1197, 1198, 1199, 1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1209, 1210, 1211, 1212, 1213, 1214, 1215, 1216, 1217, 1218, 1219, 1220, 1221, 1222, 1223, 1224, 1225, 1226, 1227, 1228, 1229, 1230, 1231, 1232, 1233, 1234, 1235, 1236, 1237, 1238, 1239, 1240, 1241, 1242, 1243, 1244, 1245, 1246, 1247, 1248, 1249, 1250, 1251, 1252, 1253, 1254, 1255, 1256, 1257, 1258, 1259, 1260, 1261, 1262, 1263, 1264, 1265, 1266, 1267, 1268, 1269, 1270, 1271, 1272, 1273, 1274, 1275, 1276, 1277, 1278, 1279, 1280, 1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1290, 1291, 1292, 1293, 1294, 1295, 1296, 1297, 1298, 1299, 1300, 1301, 1302, 1303, 1304, 1305, 1306, 1307, 1308, 1309, 1310, 1311, 1312, 1313, 1314, 1315, 1316, 1317, 1318, 1319, 1320, 1321, 1322, 1323, 1324, 1325, 845, 2027, 1458, 1253, 1265, 993, 1991, 636, 484, 770, 1867, 2000, 308, 404, 88, 789, 431, 1235, 1261, 937, 1138, 1143, 1426, 767, 1615, 1963, 575, 892, 996, 1340, 1928, 907, 836, 1233, 843, 655, 1259, 838, 1865, 919, 252, 1752, 1760, 823, 666, 1217, 801, 1209, 736, 690, 254, 886, 548, 950, 601, 987, 872, 1945, 485, 1827, 97, 762, 1843, 1425, 644, 1198, 471, 702, 43, 1402, 2029, 246, 1178, 1897, 81, 1909, 1371, 1274, 938, 1487, 1316, 694, 876, 1945, 179, 462, 376, 1829, 1424, 1298, 98, 1424, 1945, 747, 1348, 2022, 1811, 775, 3, 207, 221, 1008, 2044, 355, 1495, 1202, 753, 802, 104, 191, 1030, 1015, 1553, 1148, 1296, 1357, 283, 1575, 11, 1658, 1736, 1822, 2047, 454, 1180, 1033, 85, 1955, 1542, 1260, 676, 1574, 558, 1145, 256, 1172, 1057, 1639, 1008, 1660, 2023, 666, 971, 410, 454, 297, 1955, 1018, 1103, 441, 1200, 1705, 1229, 556, 859, 535, 518, 505, 1058, 24, 1892, 2027, 1955, 233, 1353, 1089, 1833, 219, 1483, 1837, 682, 41, 1151, 226, 75, 790, 1540, 319, 1078, 224, 858, 1293, 733, 1278, 234, 1404, 457, 938, 1934, 948, 802, 1543, 1245, 1625, 1584, 1767, 958, 1382, 1163, 1646, 1996, 1822, 342, 1156, 103, 436, 1930, 1510, 1452, 340, 1199, 2014, 1154, 747, 1640, 1854, 901, 960, 1327, 546, 617, 776, 99, 240, 142, 1627, 1423, 1175, 1495, 449, 1077, 1364, 902, 1676, 299, 307, 1212, 1306, 706, 687, 1543, 1126, 1211, 439, 666, 1307, 947, 171, 603, 1786, 116, 1467, 2046, 319, 717, 377, 592, 1269, 227, 1246, 1920, 30, 951, 81, 966, 649, 585, 1684, 1283, 134, 1195, 8, 1576, 248, 1593, 1601, 488, 1843, 318, 1622, 1632, 1372, 1696, 1908, 1452, 150, 1140, 1963, 1577, 823, 387, 325, 1087, 1658, 1375, 1582, 219, 422, 1507, 1274, 3, 1188, 1981, 565, 1876, 33, 348, 564, 671, 151, 771, 1168, 1925, 1749, 470, 1247, 204, 141, 535, 1789, 1797, 947, 780, 78, 540, 250, 609, 149, 679, 1587, 1292, 1979, 245, 627, 1943, 2042, 1023, 130, 629, 440, 745, 992, 858, 2031, 1667, 521, 1758, 1440, 180, 1150, 288, 1725, 1893, 664, 912, 1065, 1190, 262, 1159, 371, 178, 637, 794, 1807, 314, 990, 2033, 458, 559, 642, 182, 1728, 1084, 1445, 695, 1078, 1089, 1866, 104, 786, 182, 897, 795, 317, 1619, 1323, 672, 607, 735, 1558, 419, 1118, 1647, 403, 1179, 1517, 2001, 1253, 1369, 461, 1758, 1014, 1958, 141, 97, 1706, 270, 697, 1084, 992, 699, 601, 704, 927, 1216, 1809, 1095, 1058, 1686, 249, 1613, 369, 434, 808, 1075, 439, 1785, 0, 1650, 1721, 1939, 1187, 1312, 1811, 666, 1508, 386, 269, 736, 1765, 2036, 2035, 214, 1675, 543, 1444, 941, 1936, 1604, 95, 1416, 1714, 702, 895, 1844, 2042, 1437, 1431, 956, 1676, 1171, 1153, 1146, 538, 1415, 1755, 189, 38, 686, 308, 1043, 635, 1683, 1399, 659, 1939, 1563, 1211, 546, 968, 710, 2011, 1213, 1527, 316, 738, 1814, 1004, 1726, 483, 271, 1595, 1020, 534, 1430, 78, 262, 334, 638, 551, 1933, 1072, 1389, 778, 1082, 610, 835, 558, 1701, 509, 1934, 630, 24, 1995, 505, 1740, 360, 1938, 1589, 1797, 190, 681, 1513, 530, 395, 1792, 834, 880, 1643, 1751, 244, 1922, 14, 22, 255, 1319, 1850, 2034, 744, 1923, 333, 1865, 1241, 706, 1517, 1355, 1698, 996, 1122, 338, 1797, 41, 1090, 518, 201, 686, 807, 2045, 183, 899, 925, 539, 1018, 493, 1706, 1875, 753, 946, 519, 641, 74, 1250, 1793, 1910, 1243, 638, 435, 1656, 1260, 1740, 1577, 1224, 197, 1500, 1906, 1129, 1066, 1711, 19, 1253, 1736, 607, 1797, 51, 1470, 679, 1139, 336, 1795, 1781, 809, 146, 1287, 114, 155, 1263, 1292, 731, 1125, 1444, 923, 630, 1944, 1580, 1361, 846, 374, 655, 605, 1626, 705, 1553, 974, 1540, 328, 4, 329, 1155, 883, 666, 683, 1977, 1621, 1551, 698, 1804, 1847, 1546, 496, 1232, 206, 630, 1423, 1716, 1176, 158, 1456, 4, 578, 1081, 1498, 427, 484, 1933, 1876, 1318, 1537, 1110, 1097, 1829, 2025, 668, 1283, 1279, 1996, 758, 1871, 58, 253, 1762, 307, 331, 862, 1518, 80, 233, 550, 913, 559, 1051, 772, 1773, 1379, 541, 980, 1042, 883, 1360, 1396, 1113, 1994, 1570, 1785, 1844, 0, 1135, 150, 604, 1510, 1142, 805, 1740, 1466, 1924, 418, 1948, 1955, 897, 844, 544, 1384, 1515, 2043, 1341, 357, 102, 1666, 1847, 348, 108, 1713, 876, 839, 1854, 762, 1554, 1966, 1703, 432, 1091, 1124, 364, 1770, 331, 1364, 1054, 106, 1707, 399, 1007, 1869, 2011, 1509, 1901, 1637, 959, 797, 42, 840, 104, 1429, 457, 1155, 411, 1460, 799, 1272, 1412, 1669, 635, 413, 259};
#endif

//fast but weak random number generator for the sparc machine
static inline uint32_t
fast_rand() 
{
  return ((getticks()&4294967295UL)>>4);
}


static inline unsigned long* 
seed_rand() 
{
  unsigned long* seeds;
  /* seeds = (unsigned long*) ssalloc_aligned(64, 64); */
  seeds = (unsigned long*) memalign(64, 64);
  seeds[0] = getticks() % 123456789;
  seeds[1] = getticks() % 362436069;
  seeds[2] = getticks() % 521288629;
  return seeds;
}

//Marsaglia's xorshf generator
static inline unsigned long
xorshf96(unsigned long* x, unsigned long* y, unsigned long* z)  //period 2^96-1
{
  unsigned long t;
  (*x) ^= (*x) << 16;
  (*x) ^= (*x) >> 5;
  (*x) ^= (*x) << 1;

  t = *x;
  (*x) = *y;
  (*y) = *z;
  (*z) = t ^ (*x) ^ (*y);

  return *z;
}

static inline long
rand_range(long r) 
{
  /* PF_START(0); */
#if defined(LOCAL_RAND)
  long v = xorshf96(seeds, seeds + 1, seeds + 2) % r;
  v++;
#else
  int m = RAND_MAX;
  long d, v = 0;
	
  do {
    d = (m > r ? r : m);
    v += 1 + (long)(d * ((double)rand()/((double)(m)+1.0)));
    r -= m;
  } while (r > 0);
#endif
  /* PF_STOP(0); */
  return v;
}

/* Re-entrant version of rand_range(r) */
static inline long
rand_range_re(unsigned int *seed, long r) 
{
  /* PF_START(0); */
#if defined(LOCAL_RAND)
  long v = xorshf96(seeds, seeds + 1, seeds + 2) % r;
  v++;
#else
  int m = RAND_MAX;
  long d, v = 0;
	
  do {
    d = (m > r ? r : m);		
    v += 1 + (long)(d * ((double)rand_r(seed)/((double)(m)+1.0)));
    r -= m;
  } while (r > 0);
#endif
  /* PF_STOP(0); */
  return v;
}


#endif
